//
// Created by Alex Zhukov on 8/22/17.
// Copyright (c) 2017 DJI. All rights reserved.
//

import Foundation
import RxSwift

class RxDji {
    static let inspireIframe = "0000000167640032ACB402802DD2A400000FA40003A981810000632E8001650EF7BE178442350000000168EE3CB0000000016588840E7FCEB2DC5FF4FC67C4E377D00465674000000300000300000300017CB4893943CBD28A5745C0000003000111ED80008C518000E02F00015E000B78000000016500F088840E7FCEB30401F58FFFF3535641976E19BEB0C7778C69800000030000030000030087B839205A70E10F8C0FCDC8560000030000107C0004A800132B78000E000069C0000000016500782221039FCEB30400C8E7FFF9CE6ADB0BBF4CE1A21AFD600000030000030000030000277D51F90B3B6D5D600000030000298000BDDB80009F80042AD40005BC0000000165002D088840E7CEB304005CF1FFFE78A6ADB0BBF4CE1A21AFD60000030000030000030000030277D51F90B3B6D5D600000300000302980008F80022A0009D00050C0000000165003C088840E7CEB304005CF1FFFE78A6ADB0BBF4CE1A21AFD60000030000030000030000030277EAF5C5F07EDAB7F2E000000300006980017E000758002020010F00000001650012C2221039FFCEB304004379FFFE7926AC9E061DBAF676563CE79700000300000300000300004736A511C545D2B6AEB0000003000022D8000AB80023E0008A8004040000000165001682221039FFCEB304004379FFFE7926AC9E061DBAF676563CE79700000300000300000300004736A511C545D2B6AEB0000003000023A2A000018C0005F8001D6000D3800000000165001A42221039FFCEB304003238FFFF3D735618BA7F34F73AB1E73CB800000300000300000300014A1291C545D2B6AEB0000003000022D8000F88";
    static let inspirePpsHex = "68ee3cb0";
    static let inspireSpsHex = "67640032acb402802dd2a400000fa40003a981810000632e8001650ef7be17844235";

    static func inspireFrames(videoData:Observable<[UInt8]>) -> Observable<AVFrame> {
        var iframeBuf = fromHex(hex: RxDji.inspireIframe)
        iframeBuf.append(contentsOf: acc_unit_delimiter)
        let rawFrames: Observable<[UInt8]> = Observable.just(iframeBuf).concat(videoData)
        let nals = splitNals(bufSource: rawFrames)
        let annb = annexb2mp4(nals: nals)
        let frameNals = annb.toArrayUntil(predicate: { nal in
            return .ACC_UNIT_DELIM == readNal(nalu: nal[4])
        })

        let frames = frameNals.map { _nals -> [UInt8] in
            var fullFrame: [UInt8] = [];
            for nal in _nals {
                fullFrame.append(contentsOf: nal)
            }
            return fullFrame
        }

        let avframes = populatePts(frames: frames)

        return avframes
    }
}
